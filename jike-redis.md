### 开篇词-这样学redis,才能技高一筹

#### 前言

问题一:为了保证数据的可靠性,redis需要在磁盘上读写AOF和RDB,但是在高并发场景下会带来两个新的问题:1、写AOF和RDB会造成redis性能抖动,2、redis集群数据同步和实例恢复时,读RDB较慢,限制速度

解决方案:使用非易失内存NVM,可保证高速读写+快速持久话数据



#### redis使用场景

缓存、数据库、分布式锁



#### 常见的坑

- CPU-数据结构复杂度、跨CPU核的访问
- 内存-主从同步和AOF内存竞争
- 存储持久化-SSD做快照的性能抖动
- 网络通信-多实例的异常网络丢包



大部分技术人有一个误区:只关注零散的知识点,缺乏系统观.但是系统观才是至关重要的,拥有了系统观意味着你能有依据、有章法的定位、解决问题

#### Redis知识全景图

两大维度(系统维度+应用维度),三大主线(高性能、高可靠、高可扩展)

![B89BF969-5E23-4A0E-A983-50E113CFA29D](/var/folders/rn/j1054c3j5q55dcxvlcdwjs_00000gn/T/com.yinxiang.Mac/com.yinxiang.Mac/WebKitDnD.ZQVCbB/B89BF969-5E23-4A0E-A983-50E113CFA29D.png)

高性能主线:线程模型、数据结构、持久化、网络框架

高可靠主线主从复置、哨兵机制

高可扩展主线:数据分配、负载均衡



应用维度按照两种方式学习:“应用场景驱动”+“典型案例驱动” == 面的梳理+点的掌握



#### redis的问题画像图

![A6CC124F-133C-461D-8CAE-46265CDCF40D](/var/folders/rn/j1054c3j5q55dcxvlcdwjs_00000gn/T/com.yinxiang.Mac/com.yinxiang.Mac/WebKitDnD.Mz48bH/A6CC124F-133C-461D-8CAE-46265CDCF40D.png)

eg:如果你遇到redis响应变慢的问题,参照上图可看出是与性能主线相关,而性能主线又与数据结构、异步机制、RDB、AOF重写相关.



附上一张课程表的目录

![836603FC-4C5C-4B62-9050-D5B6086F03C7](/var/folders/rn/j1054c3j5q55dcxvlcdwjs_00000gn/T/com.yinxiang.Mac/com.yinxiang.Mac/WebKitDnD.0efkSU/836603FC-4C5C-4B62-9050-D5B6086F03C7.png)





### redis01--基础架构:一个键值数据库包含什么

学习最好的方式是先建立起“系统观”.若想深入理解和优化redis,必须对它的总体架构和关键模块有一个全局的认知,再深入到具体的知识点.

假设我们构建一个简单的simplekv组建,我们会如何下手?

构造简单的sinpleKV时,首先要考虑里面存了什么样的数据,对数据可做怎样的操作,即数据结构和操作接口.这些实际上是我们了解redis经常被用于缓存、秒杀、分布式锁等场景的重要基础.

#### 可以存哪些数据?

memcache 支持的value类型仅为string

redis支持的value类型包括string、哈希表、列表、集合等.redis能在实际业务场景中得到广泛的应用,得益于支持多样化类型的value.



#### 可以对数据做什么操作?

PUT/GET/DELETE/SCAN

键值对保存在外存还是内存?

内存:

(1)读写快

(2)掉电数据会丢失

外存:

(1)受限于磁盘的慢速读写,键值数据库整理性能降低

(2)避免数据丢失

键值数据库基本包含访问框架、索引模块、操作模块、存储模块四个部分.

![FC762F87-7FE4-403E-A47B-745B822380F9](/var/folders/rn/j1054c3j5q55dcxvlcdwjs_00000gn/T/com.yinxiang.Mac/com.yinxiang.Mac/WebKitDnD.OK79ib/FC762F87-7FE4-403E-A47B-745B822380F9.png)

#### 采用什么模式访问?

(1)通过函数库调用的方式供外部应用使用(如上图libsimplev.so以动态链接库的形式链接到自己程序中,提供键值存储)

(2)通过网络框架以socket通信对外提供键值对操作

实际的键值数据库也基本采用以上两种方式,rocksDB以动态链接库的形式使用

memcache和redis则通过网络框架访问.

客户端发送命令后,该命令会被封装到网络包中发送给键值数据库:

PUT HELLO WORLD

键值数据库网络框架接到网络包,安装协议进行解析,直到客户端想写入一个键值对,开始实际写入流程.

这里会产生一个系统设计上的问题:

网络连接的处理、网络请求的解析、数据存取的处理、是一个线程、多个线程、还是多个进程?如何设计和取舍?

此乃I/O模型设计.

假设一个线程既处理网络连接、解析请求、又要完成数据存取,一旦某一步操作发发生阻塞,整个线程都会阻塞,降低系统响应速度

如果采用不同线程处理,线程间访问共享资源又回产生线程竞争,也会影响系统效率.两难选择,所以需要设计.



#### 如何定位键值对的位置?

simplekv解析了客户端的请求,知道要查询操作的键值对是否存在.依赖于键值数据库的索引模块.索引的作用是根据key找到对应value存储的位置,进行操作.

索引类型常见哈希表、b+树、字典树.不同索引结构构在性能、空间消耗、并发控制不一.

memcache & redis 使用哈希表做索引,RocksDB使用跳表.



#### 不同操作具体逻辑是怎样的?

- GET/SCAN 根据value的存储位置返回value即可
- PUT 为该新的键值对分配内存空间
- DELETE 删除对应键值对并释放内存空间



#### 如何实现重启后快速提供服务?

simplekv采用了常见的内存分配器glibc的malloc和free.

simplekv依赖内存保管数据,提供快速访问,但是也希望simplekv重启后能重新提供服务,故在simplekv存储模块加了持久话功能.

将键值数据通过本地文件系统的操作接口保存在磁盘上

方法一:

对每个键值对都做落盘保存,数据更可靠但是性能会受影响

方法二:

周期性保存键值对,避免频繁写盘操作的影响,存在丢失的风险.

simplekv vs redis

![2A8998A7-8808-42C5-BC37-84F04F4FB5E2](/var/folders/rn/j1054c3j5q55dcxvlcdwjs_00000gn/T/com.yinxiang.Mac/com.yinxiang.Mac/WebKitDnD.1TowY0/2A8998A7-8808-42C5-BC37-84F04F4FB5E2.png)

(1)redis通过网络框架访问

(2)redis中value类型很丰富,有更多的操作接口.

(3)redis持久化模块支持:日志AOF+快照RDB

(4)simplekv是单机键值数据库,redis支持高可靠集群和高可扩展集群



#### 小节

simplekv和redis的对比:

[数据结构]缺乏广泛的数据支持,范围查询skiplist stream等等

[高可用]缺乏哨兵or master-slave模式的高可用

[横行扩展]缺乏集群和分片功能

[内存安全性]缺乏内存过载时的key淘汰算法

[内存利用率]未对数据结构优化提供内存利用率 如压缩性的数据结构

[不具备事务性]无法保证多个操作的原子性

[内存分配器]simplekv是glibc,redis更多

redis比memcache流行,表面上是数据结构更丰富,本质上是“计算向数据迁移”,要高性能、高可用、就需要快.memcache只支持string类型,需要获取数据必须得全量返回,返回体大,redis支持指定的数据,返回体小,标志着通过网卡的流量少,更符合redis的epoll的网络模型,尽量不阻塞.